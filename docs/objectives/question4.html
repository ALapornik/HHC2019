

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4) Windows Log Analysis: Determine Attacker Technique &mdash; HHC2019  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5) Network Log Analysis: Determine Compromised System" href="question5.html" />
    <link rel="prev" title="3) Windows Log Analysis: Evaluate Attack Outcome" href="question3.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> HHC2019
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Objectives:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="summary.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="question0.html">0) Talk to Santa in the Quad</a></li>
<li class="toctree-l1"><a class="reference internal" href="question1.html">1) Find the Turtle Doves</a></li>
<li class="toctree-l1"><a class="reference internal" href="question2.html">2) Unredact Threatening Document</a></li>
<li class="toctree-l1"><a class="reference internal" href="question3.html">3) Windows Log Analysis: Evaluate Attack Outcome</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4) Windows Log Analysis: Determine Attacker Technique</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#challenge">Challenge</a></li>
<li class="toctree-l2"><a class="reference internal" href="#answer">Answer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#solution">Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hint">Hint</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="question5.html">5) Network Log Analysis: Determine Compromised System</a></li>
<li class="toctree-l1"><a class="reference internal" href="question6.html">6) Splunk</a></li>
<li class="toctree-l1"><a class="reference internal" href="question7.html">7) Get Access To The Steam Tunnels</a></li>
<li class="toctree-l1"><a class="reference internal" href="question8.html">8) Bypassing the Frido Sleigh CAPTEHA</a></li>
<li class="toctree-l1"><a class="reference internal" href="question9.html">9) Retrieve Scraps of Paper from Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="question10.html">10) Recover Cleartext Document</a></li>
<li class="toctree-l1"><a class="reference internal" href="question11.html">11) Open the Sleigh Shop Door</a></li>
<li class="toctree-l1"><a class="reference internal" href="question12.html">12) Filter Out Poisoned Sources of Weather Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Terminals:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../terminals/EscapeEd.html">Escape Ed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/LinuxPath.html">Linux Path</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/XmasCheerLaser.html">Xmas Cheer Laser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/FrostyKeypad.html">Frosty Keypad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/HolidayHackTrail.html">Holiday Hack Trail</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/Nyanshell.html">Nyanshell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/Graylog.html">Graylog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/MongoPilfer.html">Mongo Pilfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/SmartBraces.html">Smart Braces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminals/ZeekJSONAnalysis.html">Zeek JSON Analysis</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendices:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendices/narrative.html">Narrative</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HHC2019</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>4) Windows Log Analysis: Determine Attacker Technique</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="windows-log-analysis-determine-attacker-technique">
<h1>4) Windows Log Analysis: Determine Attacker Technique<a class="headerlink" href="#windows-log-analysis-determine-attacker-technique" title="Permalink to this headline">¶</a></h1>
<div class="section" id="challenge">
<h2>Challenge<a class="headerlink" href="#challenge" title="Permalink to this headline">¶</a></h2>
<p>Difficulty: 2/5</p>
<p>Using these <a class="reference external" href="https://downloads.elfu.org/sysmon-data.json.zip">normalized Sysmon logs</a>, identify the tool the attacker used to retrieve domain password hashes from the lsass.exe process. For hints on achieving this objective, please visit Hermey Hall and talk with SugarPlum Mary.</p>
</div>
<div class="section" id="answer">
<h2>Answer<a class="headerlink" href="#answer" title="Permalink to this headline">¶</a></h2>
<p><strong>ntdsutil</strong></p>
</div>
<div class="section" id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">¶</a></h2>
<p>After unzipping the file and installing eql, we ran the following queries:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># The attacker got the hashes &#39;from&#39; lsass.exe, thus we looked for a parent_process_name=lsass.exe</span>
eql query -f sysmon-data.json <span class="s2">&quot;process where parent_process_name = &#39;lsass.exe&#39;&quot;</span> <span class="p">|</span> ./jq.exe
<span class="o">{</span>
  <span class="s2">&quot;command_line&quot;</span>: <span class="s2">&quot;C:\\Windows\\system32\\cmd.exe&quot;</span>,
  <span class="s2">&quot;event_type&quot;</span>: <span class="s2">&quot;process&quot;</span>,
  <span class="s2">&quot;logon_id&quot;</span>: <span class="m">999</span>,
  <span class="s2">&quot;parent_process_name&quot;</span>: <span class="s2">&quot;lsass.exe&quot;</span>,
  <span class="s2">&quot;parent_process_path&quot;</span>: <span class="s2">&quot;C:\\Windows\\System32\\lsass.exe&quot;</span>,
  <span class="s2">&quot;pid&quot;</span>: <span class="m">3440</span>,
  <span class="s2">&quot;ppid&quot;</span>: <span class="m">632</span>,
  <span class="s2">&quot;process_name&quot;</span>: <span class="s2">&quot;cmd.exe&quot;</span>,
  <span class="s2">&quot;process_path&quot;</span>: <span class="s2">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span>,
  <span class="s2">&quot;subtype&quot;</span>: <span class="s2">&quot;create&quot;</span>,
  <span class="s2">&quot;timestamp&quot;</span>: <span class="m">132186398356220000</span>,
  <span class="s2">&quot;unique_pid&quot;</span>: <span class="s2">&quot;{7431d376-dedb-5dd3-0000-001027be4f00}&quot;</span>,
  <span class="s2">&quot;unique_ppid&quot;</span>: <span class="s2">&quot;{7431d376-cd7f-5dd3-0000-001013920000}&quot;</span>,
  <span class="s2">&quot;user&quot;</span>: <span class="s2">&quot;NT AUTHORITY\\SYSTEM&quot;</span>,
  <span class="s2">&quot;user_domain&quot;</span>: <span class="s2">&quot;NT AUTHORITY&quot;</span>,
  <span class="s2">&quot;user_name&quot;</span>: <span class="s2">&quot;SYSTEM&quot;</span>
<span class="o">}</span>

<span class="c1"># The process_name above is cmd.exe, to see what this refers to we look for it in parent process name. To avoid a large output, we used &#39;.process_name&#39;, to only get that field</span>
eql query -f sysmon-data.json <span class="s2">&quot;process where parent_process_name = &#39;cmd.exe&#39;&quot;</span> <span class="p">|</span> ./jq.exe <span class="s1">&#39;.process_name&#39;</span>
<span class="c1"># There was a lot of data in the output, see the summary below.</span>
<span class="c1"># We get 2388 instances of net.exe, 3 instances of powershell.exe and 1 instance of ntdsutil.exe back</span>
<span class="c1"># The hint clearly states that ntdsutil is an attack tool</span>
</pre></div>
</div>
</div>
<div class="section" id="hint">
<h2>Hint<a class="headerlink" href="#hint" title="Permalink to this headline">¶</a></h2>
<p><strong>SugarPlum Mary:</strong></p>
<blockquote>
<div><p>Oh there they are! Now I can delete them. Thanks!
Have you tried the Sysmon and EQL challenge?
If you aren’t familiar with Sysmon, Carlos Perez has some great info about it.
Haven’t heard of the Event Query Language?
Check out some of <a class="reference external" href="https://www.endgame.com/our-experts/ross-wolf">Ross Wolf</a>’s work on EQL or that blog post by Josh Wright in your badge.</p>
</div></blockquote>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Sysmon</p>
<p>From: SugarPlum Mary</p>
<p><a class="reference external" href="https://www.darkoperator.com/blog/2014/8/8/sysinternals-sysmon">Sysmon By Carlos Perez</a></p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Event Query Language</p>
<p>From: SugarPlum Mary</p>
<p><a class="reference external" href="https://pen-testing.sans.org/blog/2019/12/10/eql-threat-hunting/">EQL Threat Hunting</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="question5.html" class="btn btn-neutral float-right" title="5) Network Log Analysis: Determine Compromised System" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="question3.html" class="btn btn-neutral float-left" title="3) Windows Log Analysis: Evaluate Attack Outcome" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Peter and Antonios Lapornik

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>